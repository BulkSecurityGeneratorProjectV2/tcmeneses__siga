#{extends 'main.html' /} #{set title:'Cadastro de solicitação' /}
<style>
.barra-subtitulo {
	color: #365b6d !important;
	border-bottom: 1px solid #ccc;
	border-radius: 0 !important;
	margin: 0 -15px 10px -15px;
}

.barra-subtitulo-top {
	border-radius: 5px 5px 0 0 !important;
	margin-top: -15px !important;
}
.tempo h3{
	color: #365b6d;
	font-weight: normal; 
	margin-bottom: 0px;
	font-size: 138.5%;
	border: 0;
}
</style>
<script language="javascript">

	function carregarLocalERamal(){
		frm = document.getElementById('formSolicitacao');
		params = '';
		for (i = 0; i < frm.length; i++){
			if (frm[i].name && frm[i].value)
				params = params + frm[i].name + '=' + escape(frm[i].value) + '&';
		}
		PassAjaxResponseToFunction('@{Application.exibirLocalERamal()}?' + params, 'carregouLocalERamal', null, false, null);
	}
	
	function carregouLocalERamal(response, param){
		var div = document.getElementById('divLocalERamal');
		div.innerHTML = response;
	}
	
	function carregarItem(){
		frm = document.getElementById('formSolicitacao');
		params = '';
		for (i = 0; i < frm.length; i++){
			if (frm[i].name && frm[i].value)
				params = params + frm[i].name + '=' + escape(frm[i].value) + '&';
		}
		PassAjaxResponseToFunction('@{Application.exibirItemConfiguracao()}?' + params, 'carregouItem', null, false, null);
	}
	
	function carregouItem(response, param){
		var div = document.getElementById('divItem');
		div.innerHTML = response;
		var scripts = div.getElementsByTagName("script");
		for(var i=0;i<scripts.length;i++)  
		   eval(scripts[i].text);  
	}

	function carregarConhecimentosRelacionados(){
		frm = document.getElementById('formSolicitacao');
		params = '';
		for (i = 0; i < frm.length; i++){
			if (frm[i].name && frm[i].value)
				params = params + frm[i].name + '=' + escape(frm[i].value) + '&';
		}
		PassAjaxResponseToFunction('@{Application.exibirConhecimentosRelacionados()}?' + params, 'carregouConhecimentosRelacionados', null, false, null);
	}
	
	function carregouConhecimentosRelacionados(response, param){
		var div = document.getElementById('divConhecimentosRelacionados');
		div.innerHTML = response;
		var scripts = div.getElementsByTagName("script");
		for(var i=0;i<scripts.length;i++)  
		   eval(scripts[i].text);  
	}
	
	// funções usadas para solicitações relacionadas
	function addFiltro(comboFiltro, campoRef, optionHtml, optionVl) {
		if($(campoRef).val() != "" && $(campoRef).val() != undefined) {   
			if(comboFiltro.find("option[value='"+optionVl+"']").length == 0) { 
			    var opt = document.createElement('option');
			    opt.innerHTML = optionHtml;
			    opt.value = optionVl;
			    comboFiltro.append(opt);
			  	comboFiltro.find("option[value='"+optionVl+"']").prop('selected', true);
				return true;
			}
			return null;
		}
		return false;
	}
	
	function notificarCampoMudou(campoRef, optionHtml, optionVl) {
		var comboFiltro = $('#filtro');
		if(!addFiltro(comboFiltro, campoRef, optionHtml, optionVl)) {
			var option = comboFiltro.find("option[value='"+optionVl+"']");
			option.remove();
		}
		carregarSolRelacionadas($('#filtro').val());
	}
	
	function carregarSolRelacionadas(comboFiltroVl){
		if(comboFiltroVl != ""){
			frm = document.getElementById('formSolicitacao');
			params = '';
			params = params + frm[0].name+ '=' + encodeURI(frm[0].value) + '&';
			
			if(comboFiltroVl == 'solicitacao.lotaSolicitante'){
				params = params + 'carregarLotaSolicitante=true&';
				comboFiltroVl = 'solicitacao.solicitante';			
			}
			for (i = 1; i < frm.length; i++){
				if(frm[i].name == comboFiltroVl)
					if (frm[i].name && frm[i].value){
						params = params + frm[i].name + '=' + encodeURI(frm[i].value);
						break;
					}
			}
			PassAjaxResponseToFunction('@{Application.listarSolicitacoesRelacionadas()}?' + params, 'carregouSolicitacoesRelacionadas', null, false, null);
			return;
		}
		$('#bodySolRelacionadas').html("<tr><td colspan='2' style='text-align: center;''>Não há solicitações relacionadas</td></tr>");
	}
	
	function carregouSolicitacoesRelacionadas(response, param){
		$('#bodySolRelacionadas').html(response);
	}
	
	function carregarFiltrosAoIniciar() {
		var comboFiltro = $('#filtro');
		addFiltro(comboFiltro, '#solicitacaosolicitante', 'Solicitante', 'solicitacao.solicitante');
		addFiltro(comboFiltro, '#solicitacaosolicitante', 'Lotação Solicitante', 'solicitacao.lotaSolicitante');
		addFiltro(comboFiltro, '#solicitacaoitemConfiguracao', 'Item', 'solicitacao.itemConfiguracao');
		addFiltro(comboFiltro, '#selectAcao', 'Ação', 'solicitacao.acao');
		atributos = $('#atributos').find('div');
		var atrClass, atrHtml, atrName;
		for(j=0; j < atributos.length; j++) {
			if (atributos[j].children[1] != undefined) {
				atrClass = '.'+atributos[j].children[1].className;
				atrHtml = atributos[j].firstElementChild.innerText;
				atrName = atributos[j].children[1].name;
				addFiltro(comboFiltro, atrClass, atrHtml, atrName);
			}
		}
		carregarSolRelacionadas(comboFiltro.val());
	}
	
	
	function verMais(){
		frm = document.getElementById('formSolicitacao');
		comboVl = $('#filtro').val();
		params = '';
		params = params + frm[0].name+ '=' + encodeURI(frm[0].value) + '&';
		params = params + 'filtro.pesquisar=true&';
		
		if(comboVl == 'solicitacao.lotaSolicitante'){
			params = params + 'carregarLotaSolicitante=true&';
			comboVl = 'solicitacao.solicitante';			
		}
		for (i = 1; i < frm.length; i++){
			if(frm[i].name == comboVl)
				if (frm[i].name && frm[i].value){
					params = params + frm[i].name + '=' + encodeURI(frm[i].value);
					break;
				}
		}
		params = params.replace("solicitacao", "filtro");
		window.open('@{Application.listar()}?' + params + "","_blank");
	}
</script>
<script src="/sigasr/public/javascripts/jquery.maskedinput.min.js"></script>
<script>
	$(function() {
		$("#calendarioComunicacao").datepicker({
	        showOn: "button",
	        buttonImage: "/siga/css/famfamfam/icons/calendar.png",
	        buttonImageOnly: true,
	        dateFormat: 'dd/mm/yy'
	    });
		$("#calendarioComunicacao").mask("99/99/9999");
		$("#horarioComunicacao").mask("99:99");
	});
</script>
	
<div class="gt-bd gt-cols clearfix">
	<div class="gt-content clearfix">
		<h2>#{if solicitacao.idSolicitacao || solicitacao.solicitacaoPai}${solicitacao.codigo}#{/if}
			#{else}Cadastro de Solicitação#{/else}</h2>
		<div class="gt-content-box gt-for-table gt-form" style="margin-top: 15px;">

			#{form @Application.gravar(),
			enctype:'multipart/form-data',id:'formSolicitacao' } 
				#{if solicitacao.solicitacaoPai}
				<input type="hidden" name="solicitacao.solicitacaoPai.idSolicitacao"
				value="${solicitacao.solicitacaoPai.idSolicitacao}" /> 
				#{/if}
				#{if solicitacao.idSolicitacao}
				<input
				type="hidden" name="solicitacao.idSolicitacao"
				value="${solicitacao.idSolicitacao}" /> 
				#{/if}
				<input type="hidden"
				name="solicitacao.numSolicitacao" value="${solicitacao.numSolicitacao}" />
				<input type="hidden"
				name="dtIniEdicao" value="${dtIniEdicao}" />
				<input type="hidden"
				name="solicitacao.numSequencia" value="${solicitacao.numSequencia}" />
			
			<div class="gt-form-table">
				<div class="barra-subtitulo barra-subtitulo-top header" align="center" valign="top">
					Dados básicos
				</div>
			</div>
			
			#{ifErrors}
			<p class="gt-error">Alguns campos obrigatórios não foram
				preenchidos ${error}</p>
			#{/ifErrors}

			<div class="gt-form-row gt-width-66">
				<label>Cadastrante</label> 
				${cadastrante.nomePessoa}
			</div>
			
			<div class="gt-form-row gt-width-66">
				<label>Solicitante</label> #{selecao tipo:'pessoa',
				nome:'solicitacao.solicitante', value:solicitacao.solicitante,
				onchange:"carregarLocalERamal();carregarItem();carregarConhecimentosRelacionados();
				notificarCampoMudou('#solicitacaosolicitante', 'Solicitante', 'solicitacao.solicitante');
				notificarCampoMudou('#solicitacaosolicitante', 'Lotação Solicitante', 'solicitacao.lotaSolicitante');" /}
				<span style="margin-left: 10px;">#{checkbox name:'mostrarInterlocutor', value:false, depende:'interlocutor'/} Interlocutor</span>
			</div>
			<div class="gt-form-row gt-width-66" id="interlocutor" style="display: none;">
				<label>Interlocutor</label> #{selecao tipo:'pessoa',
				nome:'solicitacao.interlocutor', value:solicitacao.interlocutor,
				onchange:'' /}
			</div>
			
			<div class="gt-form-table" style="margin-top: 10px;">
				<div class="barra-subtitulo header" align="center" valign="top">
					Contato
				</div>
			</div>
			
			<div class="gt-form-row gt-width-66">
				<label>Meio de Comunicação</label>
				#{select name:'solicitacao.meioComunicacao',
				items:models.SrMeioComunicacao.values(),
				labelProperty:'descrMeioComunicacao',
				value:solicitacao.meioComunicacao /}
			</div>
			
			<div class="gt-form-row gt-width-66" style="display: none;" id="dtInicioMeioComunicacao">
				<label>Preencha a data/hora do contato inicial:</label>
				<div class="gt-form-row gt-width-66" style="margin-left: 15px;">
					<label>Data</label>
					<input type="text" name="calendario" id="calendarioComunicacao" value="${calendario}">
					<span style="color: red">#{error 'calendario' /}</span>
				</div>
				<div class="gt-form-row gt-width-66" style="margin-left: 15px;">
					<label>Hora</label>
					<input type="text" name="horario" id="horarioComunicacao" value="${horario}">
					<span style="color: red">#{error 'horario' /}</span>
				</div>
				
			</div>
			
			<div class="gt-form-row gt-width-66">
				<label>Quando deseja receber notificação de movimentacao?</label>
				#{select name:'solicitacao.formaAcompanhamento',
				items:models.SrFormaAcompanhamento.values(),
				labelProperty:'descrFormaAcompanhamento',
				value:solicitacao.formaAcompanhamento /}
			</div>

			<div id="divLocalERamal">#{include
				'Application/exibirLocalERamal.html' /}</div>

			<div id="divItem">#{include
				'Application/exibirItemConfiguracao.html' /}</div>
			
			<div class="gt-form-table">
				<div class="barra-subtitulo header" align="center" valign="top">
					Índice GUT
				</div>
			</div>
			<div class="gt-form-row gt-width-66">
				<label>Gravidade</label> #{select name:'solicitacao.gravidade', items:models.SrGravidade.values(),
				labelProperty:'respostaEnunciado', value:'NORMAL', style:'width:235px;' /}
			</div>
			<div class="gt-form-row gt-width-66">
				<label>Urgência</label> #{select
				name:'solicitacao.urgencia', items:models.SrUrgencia.values(),
				labelProperty:'respostaEnunciado', value:'NORMAL', style:'width:235px;' /}
			</div>
			<div class="gt-form-row gt-width-66">
				<label>Tendência</label> #{select
				name:'solicitacao.tendencia', items:models.SrTendencia.values(),
				labelProperty:'respostaEnunciado', value:'PIORA_MEDIO_PRAZO', style:'width:235px;' /}
			</div>
			<div class="gt-form-table">
				<div class="barra-subtitulo header" align="center" valign="top">
					Detalhamento
				</div>
			</div>
			<div class="gt-form-row gt-width-66">
				<label>Descrição</label>
				<textarea cols="85" rows="10" name="solicitacao.descrSolicitacao"
					id="descrSolicitacao">${solicitacao.descrSolicitacao}</textarea>
				<span style="color: red">#{error
					'solicitacao.descrSolicitacao' /}</span>
			</div>
			<div class="gt-form-row gt-width-66">
				<label>Anexar arquivo</label> <input type="file"
					name="solicitacao.arquivo" />
			</div>

			#{if solicitacao.podeAbrirJaFechando(lotaTitular,cadastrante)}
			<div class="gt-form-row gt-width-66">
				<label>#{checkbox name:'solicitacao.fecharAoAbrir',
					value:solicitacao.fecharAoAbrir, depende:'motivoFechamento',
					disabled: alterando /} Fechar o chamado logo após a abertura</label>
			</div>
			#{/if}

			<div class="gt-form-row gt-width-66" id="motivoFechamento"
				style="display: none">
				<label>Motivo do fechamento</label> <input type="text" size="100"
					name="solicitacao.motivoFechamentoAbertura"
					id="motivoFechamentoAbertura" />
			</div>
			
			#{if !solicitacao.idSolicitacao || solicitacao.rascunho}
			<div class="gt-form-row">
				<label>&nbsp;</label>
				<label> 
					#{checkbox name:'solicitacao.rascunho', value:solicitacao.rascunho /} Rascunho
				</label>
			</div>
			#{/if}
			<div class="gt-form-row">
				<input type="submit" value="Gravar"
					class="gt-btn-medium gt-btn-left" />
				<a href="@{Application.listar}" class="gt-btn-medium gt-btn-left">Cancelar</a>
 			</div>
			#{/form}
		</div>
	</div>
	<div class="gt-sidebar">
		<div class="gt-sidebar-content"><h2>&nbsp;</h2></div>
	</div>
	<div class="gt-sidebar">
		<div class="gt-sidebar-content tempo">
			<h3><img src="/siga/css/famfamfam/icons/clock_play.png" width="20px;" style="vertical-align: bottom;">
				Atendimento: <span id="andamento"></span> horas</h3>
			<h3 style="margin-left: 25px;">Total: <span id="total"></span> horas</h3>
		</div>
	</div>
	<div class="gt-sidebar">
		<div class="gt-sidebar-content">
			<h3>Solicitações relacionadas <a href="#" onclick="verMais()">[Ver Mais]</a></h3>
			<div class="gt-content-box gt-form" id="filtroSolicitacoes">
				<label>Filtro</label> 
				<select name="filtro" id="filtro" onchange="carregarSolRelacionadas(this.value)"><option value="">Selecione um filtro...</option></select>
			
				<div class="gt-content-box " style="margin: 10px -16px -6px -16px; border-radius: 0 0 5px 5px !important;">
					<table border="0" width="100%" class="gt-table">
						<colgroup>
							<col width="35%" />
							<col width="65%" />
						</colgroup>
						<thead>
							<tr>
								<th>Código</th>
								<th>Teor</th>
							</tr>
						</thead>					
						<tbody id ="bodySolRelacionadas">
							#{include 'Application/listarSolicitacoesRelacionadas.html' /}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
	
	<div id="divConhecimentosRelacionados"/>
</div>

<script>
	if($('#solicitacaosolicitante').val() != $('#solicitacaointerlocutor').val()
			&& $('#solicitacaointerlocutor').val() != "") {
		$('#checkmostrarInterlocutor').prop('checked', true);	
		$('#interlocutor').show();		
	}

	$('#checkRascunho').change(function() {
		if(this.checked) {
			$('#checkRascunho').prop('value', 'true');
			return;
		}
		$('#checkRascunho').prop('value', 'false');
	});
	
	var meioComunicacao = $("select[name='solicitacao.meioComunicacao']");
	function verificarFormatoCampo() {
		if(meioComunicacao.val() === 'EMAIL'
			|| meioComunicacao.val() === 'PANDION'
			|| meioComunicacao.val() === 'CHAT') {
			$('#dtInicioMeioComunicacao').show();
			return;
		}
		$('#dtInicioMeioComunicacao').hide();
	};

	verificarFormatoCampo(); 

	meioComunicacao.change(function() {
		verificarFormatoCampo(); 
	});

	function formatarValorTimer(num) {
		if (num.toString().length == 1) 
      		return "0" + num;

  		return num;
	}

	var andamento = 0;	
	function moveRelogio(mili){ 
		andamento = andamento + mili;
	   	dtAndamento = new Date(andamento);
	   	dtTotal = new Date((${solicitacao.getTempoCadastramentoTotal()} + andamento));
	   	
	   	andamentoString = formatarValorTimer(dtAndamento .getUTCHours()) + ":" + formatarValorTimer(dtAndamento .getUTCMinutes()); 
	   	totalString = formatarValorTimer(dtTotal .getUTCHours()) + ":" + formatarValorTimer(dtTotal .getUTCMinutes()); 

	   	$('#andamento').html(andamentoString);
	   	$('#total').html(totalString);

	   	setTimeout("moveRelogio(60000)",60000);
	} 

	carregarFiltrosAoIniciar();
	moveRelogio(0);
</script>
