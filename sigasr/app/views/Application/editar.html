#{extends 'main.html' /} #{set title:'Cadastro de solicitação' /}

<script language="javascript">

	function carregarLocalERamal(){
		frm = document.getElementById('formSolicitacao');
		params = '';
		for (i = 0; i < frm.length; i++){
			if (frm[i].name && frm[i].value)
				params = params + frm[i].name + '=' + escape(frm[i].value) + '&';
		}
		PassAjaxResponseToFunction('@{Application.exibirLocalERamal()}?' + params, 'carregouLocalERamal', null, false, null);
	}
	
	function carregouLocalERamal(response, param){
		var div = document.getElementById('divLocalERamal');
		div.innerHTML = response;
	}
	
	function carregarItem(){
		frm = document.getElementById('formSolicitacao');
		params = '';
		for (i = 0; i < frm.length; i++){
			if (frm[i].name && frm[i].value)
				params = params + frm[i].name + '=' + escape(frm[i].value) + '&';
		}
		PassAjaxResponseToFunction('@{Application.exibirItemConfiguracao()}?' + params, 'carregouItem', null, false, null);
	}
	
	function carregouItem(response, param){
		var div = document.getElementById('divItem');
		div.innerHTML = response;
		var scripts = div.getElementsByTagName("script");
		for(var i=0;i<scripts.length;i++)  
		   eval(scripts[i].text);  
	}

function carregarConhecimentosRelacionados(){
	frm = document.getElementById('formSolicitacao');
	params = '';
	for (i = 0; i < frm.length; i++){
		if (frm[i].name && frm[i].value)
			params = params + frm[i].name + '=' + escape(frm[i].value) + '&';
	}
	PassAjaxResponseToFunction('@{Application.exibirConhecimentosRelacionados()}?' + params, 'carregouConhecimentosRelacionados', null, false, null);
}

function carregouConhecimentosRelacionados(response, param){
	var div = document.getElementById('divConhecimentosRelacionados');
	div.innerHTML = response;
	var scripts = div.getElementsByTagName("script");
	for(var i=0;i<scripts.length;i++)  
	   eval(scripts[i].text);  
}

</script>
<script>
$(function() {
    $( "#calendario" ).datepicker({
        showOn: "button",
        buttonImage: "/siga/css/famfamfam/icons/calendar.png",
        buttonImageOnly: true,
        dateFormat: 'dd/mm/yy'
    });
});

$(function(){
	$("#horario").mask("99:99");
});
</script>

<div class="gt-bd gt-cols clearfix">
	<div class="gt-content clearfix">
		<h2>#{if solicitacao.idSolicitacao || solicitacao.solicitacaoPai}${solicitacao.codigo}#{/if}
			#{else}Cadastro de Solicitação#{/else}</h2>
		<div class="gt-content-box gt-form">

			#{form @Application.gravar(),
			enctype:'multipart/form-data',id:'formSolicitacao' } 
				#{if solicitacao.solicitacaoPai}
				<input type="hidden" name="solicitacao.solicitacaoPai.idSolicitacao"
				value="${solicitacao.solicitacaoPai.idSolicitacao}" /> 
				#{/if}
				#{if solicitacao.idSolicitacao}
				<input
				type="hidden" name="solicitacao.idSolicitacao"
				value="${solicitacao.idSolicitacao}" /> 
				#{/if}
				<input type="hidden"
				name="solicitacao.numSolicitacao" value="${solicitacao.numSolicitacao}" />
				<input type="hidden"
				name="solicitacao.numSequencia" value="${solicitacao.numSequencia}" />

			#{ifErrors}
			<p class="gt-error">Alguns campos obrigatórios não foram
				preenchidos ${error}</p>
			#{/ifErrors}

			<div class="gt-form-row gt-width-66">
				<label>Cadastrante</label> 
				${cadastrante.nomePessoa}
			</div>
			
			<div class="gt-form-row gt-width-66">
				<label>Solicitante</label> #{selecao tipo:'pessoa',
				nome:'solicitacao.solicitante', value:solicitacao.solicitante,
				onchange:'carregarLocalERamal();carregarItem();carregarConhecimentosRelacionados();' /}
				<span style="margin-left: 10px;">#{checkbox name:'mostrarInterlocutor', value:false, depende:'interlocutor'/} Interlocutor</span>
			</div>
			
			<div class="gt-form-row gt-width-66" id="interlocutor" style="display: none;">
				<label>Interlocutor</label> #{selecao tipo:'pessoa',
				nome:'solicitacao.interlocutor', value:solicitacao.interlocutor,
				onchange:'' /}
			</div>
			
			<div class="gt-form-row gt-width-66">
				<label>Meio de Comunicação</label>
				#{select name:'solicitacao.meioComunicacao',
				items:models.SrMeioComunicacao.values(),
				labelProperty:'descrMeioComunicacao',
				value:solicitacao.meioComunicacao /}
			</div>
			
			<div class="gt-form-row gt-width-66" style="display: none;" id="dtInicioMeioComunicacao">
				<label>Preencha a data/hora do contato inicial:</label>
				<div class="gt-form-row gt-width-66" style="margin-left: 15px;">
					<label>Data</label>
					<input type="text" name="calendario" id="calendario" value="${calendario}">
					<span style="color: red">#{error 'calendario' /}</span>
				</div>
				<div class="gt-form-row gt-width-66" style="margin-left: 15px;">
					<label>Hora</label>
					<input type="text" name="horario" id="horario" value="${horario}">
					<span style="color: red">#{error 'horario' /}</span>
				</div>
				
			</div>
			
			<div class="gt-form-row gt-width-66">
				<label>Quando deseja receber notificação de movimentacao?</label>
				#{select name:'solicitacao.formaAcompanhamento',
				items:models.SrFormaAcompanhamento.values(),
				labelProperty:'descrFormaAcompanhamento',
				value:solicitacao.formaAcompanhamento /}
			</div>

			<div id="divLocalERamal">#{include
				'Application/exibirLocalERamal.html' /}</div>

			<div id="divItem">#{include
				'Application/exibirItemConfiguracao.html' /}</div>

			<div class="gt-form-row gt-width-66">
				<label>Gravidade</label> #{select name:'solicitacao.gravidade', items:models.SrGravidade.values(),
				labelProperty:'respostaEnunciado', value:'NORMAL', style:'width:235px;' /}
			</div>
			<div class="gt-form-row gt-width-66">
				<label>Urgência</label> #{select
				name:'solicitacao.urgencia', items:models.SrUrgencia.values(),
				labelProperty:'respostaEnunciado', value:'NORMAL', style:'width:235px;' /}
			</div>
			<div class="gt-form-row gt-width-66">
				<label>Tendência</label> #{select
				name:'solicitacao.tendencia', items:models.SrTendencia.values(),
				labelProperty:'respostaEnunciado', value:'PIORA_MEDIO_PRAZO', style:'width:235px;' /}
			</div>
			
			<div class="gt-form-row gt-width-66">
				<label>Descrição</label>
				<textarea cols="85" rows="10" name="solicitacao.descrSolicitacao"
					id="descrSolicitacao">${solicitacao.descrSolicitacao}</textarea>
				<span style="color: red">#{error
					'solicitacao.descrSolicitacao' /}</span>
			</div>
			<div class="gt-form-row gt-width-66">
				<label>Anexar arquivo</label> <input type="file"
					name="solicitacao.arquivo" />
			</div>

			#{if solicitacao.podeAbrirJaFechando(lotaTitular,cadastrante)}
			<div class="gt-form-row gt-width-66">
				<label>#{checkbox name:'solicitacao.fecharAoAbrir',
					value:solicitacao.fecharAoAbrir, depende:'motivoFechamento',
					disabled: alterando /} Fechar o chamado logo após a abertura</label>
			</div>
			#{/if}

			<div class="gt-form-row gt-width-66" id="motivoFechamento"
				style="display: none">
				<label>Motivo do fechamento</label> <input type="text" size="100"
					name="solicitacao.motivoFechamentoAbertura"
					id="motivoFechamentoAbertura" />
			</div>
			
			<div class="gt-form-row gt-width-66">
				<label>Quando deseja receber notificação de movimentacao?</label>
				#{select name:'solicitacao.formaAcompanhamento',
				items:models.SrFormaAcompanhamento.values(),
				labelProperty:'descrFormaAcompanhamento',
				value:solicitacao.formaAcompanhamento /}
			</div>

			<div class="gt-form-row">
				<input type="submit" value="Gravar"
					class="gt-btn-medium gt-btn-left" />
				<a href="@{Application.listar}" class="gt-btn-medium gt-btn-left">Cancelar</a>
			</div>
			#{/form}
		</div>
	</div>
	<div id="divConhecimentosRelacionados">#{include
				'Application/exibirConhecimentosRelacionados.html' /}</div>
</div>
<script>

		if($('#solicitacaosolicitante').val() != $('#solicitacaointerlocutor').val()
				&& $('#solicitacaointerlocutor').val() != "") {
			$('#checkmostrarInterlocutor').prop('checked', true);	
			$('#interlocutor').show();		
		}
	
	var meioComunicacao = $("select[name='solicitacao.meioComunicacao']");
	function verificarFormatoCampo() {
		if(meioComunicacao.val() === 'EMAIL'
			|| meioComunicacao.val() === 'PANDION'
			|| meioComunicacao.val() === 'CHAT') {
			$('#dtInicioMeioComunicacao').show();
			return;
		}
		$('#dtInicioMeioComunicacao').hide();
	};

	verificarFormatoCampo(); 

	meioComunicacao.change(function() {
		verificarFormatoCampo(); 
	});
</script>
