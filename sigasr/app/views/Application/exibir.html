#{extends 'main.html' /}

<script language="javascript">
function carregarAtendente(){
	frm = document.getElementById('formAndamento');
	params = '';
	for (i = 0; i < frm.length; i++){
		params = params + '&' + frm[i].name + '=' + escape(frm[i].value);
	}
	PassAjaxResponseToFunction('@{Application.exibirAtendente()}', 'carregouAtendente', null, false, params);
}

function carregouAtendente(response, param){
	var div = document.getElementById('divAtendente');
	div.innerHTML = response;
	var scripts = div.getElementsByTagName("script");
	for(var i=0;i<scripts.length;i++)  
	   eval(scripts[i].text);  
}

</script>
<div class="gt-bd gt-cols clearfix" style="padding-bottom:0px;">
	<div class="gt-content clearfix">
		<h2>Solicitação ${solicitacao.codigo}</h2>
		<p class="gt-table-action-list">
			#{if editar} <a class="once"
				href="@{Application.editar(solicitacao.idSolicitacao)}"> <img
				src="/siga/css/famfamfam/icons/pencil.png"
				style="margin-right: 5px;">Editar</a>&nbsp;&nbsp;&nbsp; #{/if}
			#{if criarFilha} <a class="once"
				href="@{Application.criarFilha(solicitacao.idSolicitacao)}"> <img
				src="/siga/css/famfamfam/icons/arrow_divide.png"
				style="margin-right: 5px;">Criar solicitação filha</a>&nbsp;&nbsp;&nbsp;
			#{/if}
		</p>
		
		#{quadroSolicitacao solicitacao:solicitacao, modoCompleto:true /}
		
		<h3 style="padding-top: 25px;">Próximo Andamento</h3>
		<div class="gt-content-box gt-form" style="margin-bottom: 0px !important;">
			#{form @Application.andamento(), enctype:'multipart/form-data',
			id:'formAndamento'} <input type="hidden"
				name="andamento.solicitacao.idSolicitacao"
				value="${solicitacao.idSolicitacao}"> #{if
			movimentarPlenamente}
			<div class="gt-form-row gt-width-66">
				<label>Situação</label> #{select 'andamento.estado', items:estados,
				labelProperty:'descrEstado', value:andamento.estado,
				valueProperty:idEstado, onchange:'carregarAtendente();'} #{/select}
			</div>

			<div class="gt-form-row gt-width-66">
				<label>Atendente</label>
				<div id="divAtendente">#{include
					'Application/exibirAtendente.html' /}</div>
			</div>
			#{/if}

			<div class="gt-form-row gt-width-66">
				<label>Descrição</label>
				<textarea name="andamento.descrAndamento" id="descrSolicitacao"
					cols="70" rows="4" value="${andamento.descrAndamento}"></textarea>
			</div>
			<div class="gt-form-row gt-width-66">
				<label>Anexar arquivo</label> <input type="file"
					name="andamento.arquivo">
			</div>

			<div class="gt-form-row">
				<input type="submit" value="Gravar"
					class="gt-btn-medium gt-btn-left" />
			</div>
			#{/form}
		</div>
	</div>

	<div class="gt-sidebar">
		<div class="gt-sidebar-content">
			<h3>Dados da Solicitação</h3>
			<p>
				<b>Órgão Usuário:</b> ${informacao?.ou?.acronimoOrgaoUsu}
			</p>
			<p>
				<b>Autor:</b> ${informacao?.autor?.descricaoIniciaisMaiusculas} -
				${informacao?.autor?.sigla}
			</p>
			<p>
				<b>Lotação:</b> ${informacao?.lotacao?.descricaoIniciaisMaiusculas}
				- ${informacao?.lotacao?.sigla}
			</p>
			<p>
				<b>Data:</b> ${informacao?.dtIniString}
			</p>
			<p>
				<b>Finalizado em:</b> ${informacao?.elaboracaoFim}
			</p>
			<!--  -->
			#{set cls = informacao?.arq?.classificacao?.split(",") /}
			<!--  -->
			#{if cls != null && cls.size() > 1}
			<p>
				<b>Classificações:</b>
			<ul>
				#{list items:cls, as:'cl'}
				<li>${cl}</li> #{/list}
			</ul>
			</p>
			#{/if}#{else}
			<p>
				<b>Classificação:</b> ${informacao?.arq?.classificacao}
			</p>
			#{/else}

		</div>
		<!-- / sidebar -->
		<div class="gt-sidebar-content" id="gc"></div>
		
	</div>
</div>

<div class="gt-bd" style="padding-bottom: 0px;">
	<div class="gt-content">
		<h3>Andamentos</h3>
	</div>

	<div class="gt-content-box">
	<table border="0" class="gt-table">
		<thead>
			<tr>
				<th>Momento</th>
				<th>Situação</th>
				<th colspan="2">Cadastrante</th>
				<th colspan="2">Atendente</th>
				<th>Descrição</th>
				<th></th>
			</tr>
		</thead>

		<tbody>
			#{list items:solicitacao.andamentoSet, as:'andamento'}
			<tr id="linha${andamento.idAndamento}" #{if
				andamento_isFirst && desfazerAndamento}
						onmouseover="var img = document.getElementById('imgCancelar'); if (img) img.src='/siga/css/famfamfam/icons/cancel.png';"
				onmouseout="var img = document.getElementById('imgCancelar'); if (img) img.src='/siga/css/famfamfam/icons/cancel_gray.png';"#{/if}>
				<td>${andamento.dtRegString}</td>
				<td>${andamento.estado.descrEstado}</td>
				<td>#{selecionado
					sigla:andamento.lotaCadastrante?.siglaLotacao,
					descricao:andamento.lotaCadastrante?.nomeLotacao /}</td>
				<td>#{selecionado sigla:andamento.cadastrante?.nomeAbreviado,
					descricao:andamento.cadastrante?.descricaoIniciaisMaiusculas /}</td>
				<td>#{selecionado sigla:andamento.lotaAtendente?.siglaLotacao,
					descricao:andamento.lotaAtendente?.nomeLotacao /}</td>
				<td>#{selecionado sigla:andamento.atendente?.nomeAbreviado,
					descricao:andamento.atendente?.descricaoIniciaisMaiusculas /}</td>
				<td id="descrAndamento${andamento.idAndamento}">${andamento.descrAndamento}#{if
					andamento.arquivo}&nbsp;&nbsp;|&nbsp;&nbsp;#{arquivo
					arquivo:andamento.arquivo /}#{/if}</td>
				<script language="javascript">
							var descricao = document.getElementById('descrAndamento${andamento.idAndamento}');
							descricao.innerHTML = descricao.innerHTML.replace(/\n\r?/g, '<br />');
						</script>
				<td>#{if andamento_isFirst && desfazerAndamento} <a
					class="once"
					href="@{Application.desfazerUltimoAndamento(solicitacao.idSolicitacao)}"
					title="Desfazer este andamento"> <img id="imgCancelar"
						src="/siga/css/famfamfam/icons/cancel_gray.png"
						style="margin-right: 5px;"> </a>#{/if}</td>
			</tr>
			#{/list}
		</tbody>
	</table>
</div>
<!-- /content box -->

</div>

	#{if controllers.SigaApplication.podeUtilizarServico('SIGA;GC')} 
	<script type="text/javascript">
		SetInnerHTMLFromAjaxResponse("/../sigagc/knowledge?tags=@sr-item:${solicitacao.itemConfiguracao.siglaItemConfiguracao}&tags=@sr-acao:${solicitacao.servico.siglaServico}&estilo=sidebar&ts=${currentTimeMillis}",document.getElementById('gc'));
	</script>
	#{/if} 

