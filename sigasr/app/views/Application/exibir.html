#{extends 'main.html' /} #{set title:'MovimentaÃ§Ã£o de solicitação' /}

<div class="gt-bd gt-cols clearfix" style="padding-bottom: 0px;">
	<div class="gt-content clearfix">
		<h2> ${solicitacao.codigo} - ${solicitacao.itemConfiguracao?.descricao} - ${solicitacao.servico?.descricao}</h2>
		<h3>${solicitacao.getMarcadoresEmHtml(cadastrante, lotaTitular)}</h3>
	   	<p class="gt-table-action-list">
			#{if solicitacao.podeEditar(lotaTitular, cadastrante)} <a class="once"
				href="@{Application.editar(solicitacao.idSolicitacao)}"> <img
				src="/siga/css/famfamfam/icons/pencil.png"
				style="margin-right: 5px;">Editar</a>&nbsp;&nbsp;&nbsp; #{/if}
			#{if solicitacao.podeCriarFilha(lotaTitular,
				cadastrante)} <a class="once"
				href="@{Application.criarFilha(solicitacao.idSolicitacao)}"> <img
				src="/siga/css/famfamfam/icons/arrow_divide.png"
				style="margin-right: 5px;">Criar solicitação filha</a>&nbsp;&nbsp;&nbsp;
			#{/if}
			#{if !considerarCancelados} <a class="once"
				href="@{Application.exibir(solicitacao.idSolicitacao)}?considerarCancelados=true"> <img
				src="/siga/css/famfamfam/icons/eye.png"
				style="margin-right: 5px;">Ver Todas as Movimentações</a>&nbsp;&nbsp;&nbsp;
			#{/if}
			<a class="once"
				href="@{Application.associarLista(solicitacao.idSolicitacao)}"> <img
				src="/siga/css/famfamfam/icons/text_list_numbers.png"
				style="margin-right: 5px;">Definir Lista</a>&nbsp;&nbsp;&nbsp;
			#{if solicitacao.podeFechar(lotaTitular)}
			<a class="once"
				href="@{Application.fechar(solicitacao.idSolicitacao)}"> <img
				src="/siga/css/famfamfam/icons/control_stop_blue.png"
				style="margin-right: 5px;">Fechar</a>&nbsp;&nbsp;&nbsp;
			#{/if}
			#{if solicitacao.podeFinalizarPreAtendimento(lotaTitular)}
			<a class="once"
				href="@{Application.finalizarPreAtendimento(solicitacao.idSolicitacao)}"> <img
				src="/siga/css/famfamfam/icons/accept.png"
				style="margin-right: 5px;">Finalizar Pré-atendimento</a>&nbsp;&nbsp;&nbsp;
			#{/if}
			#{if solicitacao.podeFinalizarPosAtendimento(lotaTitular)}
			<a class="once"
				href="@{Application.finalizarPosAtendimento(solicitacao.idSolicitacao)}"> <img
				src="/siga/css/famfamfam/icons/control_stop_blue.png"
				style="margin-right: 5px;">Finalizar Póss-atendimento</a>&nbsp;&nbsp;&nbsp;
			#{/if}
			#{if solicitacao.podeCancelar(lotaTitular)}
			<a class="once"
				href="@{Application.cancelar(solicitacao.idSolicitacao)}"> <img
				src="/siga/css/famfamfam/icons/cross.png"
				style="margin-right: 5px;">Cancelar</a>&nbsp;&nbsp;&nbsp;
			#{/if}
			#{if solicitacao.podeReabrir(lotaTitular)}
			<a class="once"
				href="@{Application.reabrir(solicitacao.idSolicitacao)}"> <img
				src="/siga/css/famfamfam/icons/control_play_blue.png"
				style="margin-right: 5px;">Reabrir</a>&nbsp;&nbsp;&nbsp;
			#{/if}
			#{if solicitacao.podeDeixarPendente(lotaTitular)}
			<a class="once"
				href="@{Application.deixarPendente(solicitacao.idSolicitacao)}"> <img
				src="/siga/css/famfamfam/icons/clock_pause.png"
				style="margin-right: 5px;">Deixar Pendente</a>&nbsp;&nbsp;&nbsp;
			#{/if}
			#{if solicitacao.podeTerminarPendencia(lotaTitular)}
			<a class="once"
				href="@{Application.terminarPendencia(solicitacao.idSolicitacao)}"> <img
				src="/siga/css/famfamfam/icons/clock_play.png"
				style="margin-right: 5px;">Terminar Pendência</a>&nbsp;&nbsp;&nbsp;
			#{/if}
			#{if solicitacao.podeAnexarArquivo(lotaTitular)}
			<a class="once"
				href="@{Application.anexarArquivo(solicitacao.idSolicitacao)}"
				onclick="$('#anexar-arquivo-dialog').dialog('open');return false;"> <img
				src="/siga/css/famfamfam/icons/attach.png"
				style="margin-right: 5px;">Anexar Arquivo</a>&nbsp;&nbsp;&nbsp;
			#{/if}
		</p>
		<div class="gt-content-box">
					<p style="font-size: 9pt; padding: 7px 10px; margin-bottom: 0px;" id="descrSolicitacao">
			    						${solicitacao.descrSolicitacao}</p>
			#{list items:solicitacao.atributoSet, as:'att'}
				#{if att.valorAtributo}
				<p style="font-size: 9pt; padding: 0px 10px"><b>${att.tipoAtributo.nomeTipoAtributo}:</b> ${att.valorAtributo}</p>
				#{/if}
			#{/list}
		</div>

		<h3 style="padding-top: 25px;">Próximo Andamento</h3>
		<div class="gt-content-box gt-form">
			<form action="@{Application.darAndamento()}" method="post" enctype="multipart/form-data">
				<input type="hidden" name="movimentacao.solicitacao.idSolicitacao"
						value="${movimentacao.solicitacao.idSolicitacao}"> #{if
					solicitacao.estaCom(lotaTitular, cadastrante)}
				<div class="gt-form-row gt-width-66">
					<label>Atendente</label>
					<div id="divAtendente">
						#{pessoaLotaSelecao nomeSelLotacao:'movimentacao.lotaAtendente',
							nomeSelPessoa:'movimentacao.atendente',
							valuePessoa:movimentacao.atendente,
							valueLotacao:movimentacao.lotaAtendente,
							disabled:disabled /}
					</div>
				</div>	
					#{/if}
		
				<div style="display: inline" class="gt-form-row gt-width-66">
					<label>Descrição</label>
					<textarea style="width: 100%" name="movimentacao.descrMovimentacao" id="descrSolicitacao"
						cols="70" rows="4" value="${movimentacao.descrMovimentacao}"></textarea>
				</div>
		
				<div class="gt-form-row">
					<input type="submit" value="Gravar"
							class="gt-btn-medium gt-btn-left" />
				</div>
			</form> 
		</div>
		
		<h3>Andamentos</h3>
		
		<div class="gt-content-box">
		<table border="0" width="100%" class="gt-table mov">
		    <colgroup>
    			<col width="15%"/>
    			<col width="10%"/>
    			<col width="10%"/>
    			<col width="65"/>
    			<col width="5%"/>
  			</colgroup>
			<thead>
				<tr>
				#{if considerarCancelados}
					<th></th>
				#{/if}	
					<th>Momento</th>
					<th colspan="2">Cadastrante</th>
					<th>Descrição</th>
					<th></th>
				</tr>
			</thead>

			<tbody>
				#{list items:solicitacao.getMovimentacaoSet(considerarCancelados, 2), as:'movimentacao'}
				<tr id="linha${movimentacao.idMovimentacao}" 
				#{if movimentacao.cancelado} class="disabled" #{/if} 
				#{set desfazerMovimentacao: solicitacao.podeDesfazerMovimentacao(lotaTitular, cadastrante) /}
				#{if desfazerMovimentacao && (!movimentacao.cancelado && (movimentacao.idMovimentacao == solicitacao.ultimaMovimentacao.idMovimentacao))} 
					onmouseover="var img = document.getElementById('imgCancelar'); if (img) img.src='/siga/css/famfamfam/icons/cancel.png';"
					onmouseout="var img = document.getElementById('imgCancelar'); if (img) img.src='/siga/css/famfamfam/icons/cancel_gray.png';"
					#{/if}>
					#{if considerarCancelados} 
					<td>${movimentacao.numSequencia}</td>
					#{/if}
					#{if !considerarCancelados}<td>${movimentacao.dtIniString}</td>#{/if}
					#{else}<td>${movimentacao.dtIniMovDDMMYYHHMM}</td>#{/else}
					<td>#{selecionado
						sigla:movimentacao.lotaCadastrante?.siglaLotacao,
						descricao:movimentacao.lotaCadastrante?.nomeLotacao /}</td>
					<td>#{selecionado sigla:movimentacao.cadastrante?.nomeAbreviado,
						descricao:movimentacao.cadastrante?.descricaoIniciaisMaiusculas /}</td>
					<td id="descrMovimentacao${movimentacao.idMovimentacao}">${movimentacao.descrMovimentacao}#{if
						movimentacao.arquivo}&nbsp;&nbsp;|&nbsp;&nbsp;#{arquivo
						arquivo:movimentacao.arquivo /}#{/if}</td>
					<script language="javascript">
							var descricao = document.getElementById('descrMovimentacao${movimentacao.idMovimentacao}');
							descricao.innerHTML = descricao.innerHTML.replace(/\n\r?/g, '<br />');
					</script>
					<td style="text-align: right">#{if desfazerMovimentacao && (!movimentacao.cancelado && (movimentacao.idMovimentacao == solicitacao.ultimaMovimentacao.idMovimentacao))} 
					<a
						class="once"
						href="@{Application.desfazerUltimaMovimentacao(solicitacao.idSolicitacao)}"
						title="Desfazer esta movimentação"> <img id="imgCancelar"
							src="/siga/css/famfamfam/icons/cancel_gray.png"
							style="margin-right: 5px;"> </a>#{/if}</td>
  				</tr>
				#{/list}
			</tbody>
		</table>
		</div>
		
		
	</div>


	<div class="gt-sidebar">
		<div class="gt-sidebar-content">
			<h3>Dados da Solicitação</h3>
			<p>
				<b>Solicitante:</b> ${solicitacao?.solicitante?.descricaoIniciaisMaiusculas}
			</p>
			<p>
				<b>Lotaçãoo:</b> ${solicitacao.lotaSolicitante?.siglaLotacao} 
				#{if solicitacao.local}
				(${solicitacao.local.nomeComplexo})
				#{/if}
			</p>
			#{if solicitacao.telPrincipal}
			<p>
				<b>Telefone:</b> ${solicitacao.telPrincipal} 
			</p>
			#{/if}
			<p>
				<b>Cadastrante:</b> ${solicitacao?.cadastrante?.descricaoIniciaisMaiusculas}
			</p>
			<p>
				<b>Abertura:</b> ${solicitacao.solicitacaoInicial.dtRegString}
			</p>
			<p>
			<b>Item de Configuraçãoo:</b>
			${solicitacao.itemConfiguracao?.siglaItemConfiguracao} - ${solicitacao.itemConfiguracao?.descricaoCompleta}
			</p>
			<p>
			<b>Ação:</b>
			${solicitacao.servico?.siglaServico} - ${solicitacao.servico?.descricaoCompleta}
			</p>
			#{if solicitacao.arquivo}
			<p>
				<b>Arquivo anexo: </b>	#{arquivo
						arquivo:solicitacao.arquivo /} 
			</p>
			#{/if}
			#{if (solicitacao?.GUT > 80)} #{set priorColor:'color: red' /} #{/if}
						#{elseif (solicitacao?.GUT > 60)} #{set priorColor:'color: orange' /} #{/elseif}
						#{else} #{set priorColor:'' /} #{/else}
			<p>
				<b>Prioridade:</b> <span style="${priorColor}">${solicitacao.GUTPercent} ${solicitacao.GUTString}</span> 
			</p>
		</div>
	</div>

	#{if solicitacao.parteDeArvore}
	<div class="gt-sidebar">
		<div class="gt-sidebar-content">
			<h3>Contexto</h3>
				<p>
					#{listaArvore solicitacao:solicitacao.paiDaArvore,visualizando:solicitacao /}
				</p>
		</div>
		<div class="gt-sidebar-content" id="gc"></div>
	</div>
	#{/if}

	<div class="gt-sidebar">
		<div class="gt-sidebar-content">
			<h3>Listas de Prioridade</h3>
				<p>
					#{list items:solicitacao.getListaAssociada(), as:'listassoc'}
					<tr>
						<td class="gt-form-row gt-width-66" style="font-size: 13px; font-weight: bold; !important; padding: 7px 10px;">
						&nbsp;
						<input type="hidden" name="idlista" value="${listassoc?.idLista}">
							<a style="color: #365b6d;text-decoration: none" href="@{Application.exibirLista(listassoc?.idLista)}">
						 	${listassoc?.nomeLista}		
							</a>	
						</td>
					</tr>	
					#{/list}
				</p>
		</div>
	</div>
	
	#{if solicitacao.temArquivosAnexos()}
	<div class="gt-sidebar">
		<div class="gt-sidebar-content">
			<h3>Arquivos Anexos</h3>
				<p>
					#{list items:solicitacao.anexacoes, as:'anexacao'}
						#{arquivo arquivo:anexacao.arquivo /} ${anexacao.descrMovimentacao}<br/>
					#{/list}
				</p>
		</div>
	</div>
	#{/if}
	
</div>

#{if controllers.SigaApplication.podeUtilizarServico('SIGA;GC')}
<script type="text/javascript">
		SetInnerHTMLFromAjaxResponse("/../sigagc/knowledge?${solicitacao.gcTags.raw()}&estilo=sidebar&ts=${currentTimeMillis}",document.getElementById('gc'));
</script>
#{/if}











<div id="anexar-arquivo-dialog" title="Andamento">
<div class="gt-content-box gt-form">
			<form action="@{Application.anexarArquivo()}" method="post" enctype="multipart/form-data">
				<input type="hidden" name="movimentacao.solicitacao.idSolicitacao"
						value="${movimentacao.solicitacao.idSolicitacao}"> 
				<input type="hidden" name="movimentacao.tipoMov.idTipoMov"
						value="12"> 
				<div class="gt-form-row gt-width-66">
					<label>Arquivo</label> <input type="file"
							name="movimentacao.arquivo">
				</div>
				<div style="display: inline" class="gt-form-row gt-width-66">
					<label>Descrição</label>
					<textarea style="width: 100%" name="movimentacao.descrMovimentacao" id="descrSolicitacao"
						cols="70" rows="4" value="${movimentacao.descrMovimentacao}"></textarea>
				</div>
				<div class="gt-form-row">
					<input type="submit" value="Gravar"
							class="gt-btn-medium gt-btn-left" />
				</div>
			</form> 
		</div>

</div>

<script>
$("#anexar-arquivo-dialog").dialog({
      autoOpen: false,
      height: 300,
      width: 400,
      modal: true,
      resizable: false
    });
</script>