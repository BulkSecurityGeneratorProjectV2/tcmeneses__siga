#{extends 'main.html' /} #{set title:'Exibição de solicitação' /}
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<script src="//cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>
<script src="/sigasr/public/javascripts/jquery.serializejson.min.js"></script>
<script src="/sigasr/public/javascripts/jquery.populate.js"></script>
<script src="/sigasr/public/javascripts/base-service.js"></script>

<style>
#sortable table { height: 1.5em; line-height: 1.2em; }
.ui-state-highlight { height: 1.5em; line-height: 1.2em; }
</style>

#{set podeRemover:lista.podeRemover(lotaTitular, cadastrante) /}
#{set podeEditar:lista.podeEditar(lotaTitular, cadastrante) /}
#{set podePriorizar:lista.podePriorizar(lotaTitular, cadastrante) /}

<div class="gt-bd clearfix">
	<div class="gt-content clearfix">
	<h2 id="tituloPagina"> ${lista.nomeLista}</h2>
	
		<p class="gt-table-action-list">
			#{if podeEditar} 
				<a href="#" onclick="javascript: editarLista(event, ${lista.toJson()})"> 
					<img src="/siga/css/famfamfam/icons/pencil.png" style="margin-right: 5px;">Editar
				</a>&nbsp;&nbsp;&nbsp; #{/if}
		</p>
		
		#{solicitacoes solicitacaoListaVO:solicitacaoListaVO, filtro:filtro, modoExibicao:'lista' /}
	</div>	
</div>

<!-- /content box -->
<div class="gt-table-buttons">
	<input type="hidden" name="idLista" value="${lista.idLista}">
	#{if podePriorizar} 
	<input type="button" id="btn" value="Gravar" class="gt-btn-medium gt-btn-left" />#{/if}
	<a href="@{Application.listarLista}" class="gt-btn-medium gt-btn-left">Cancelar</a>
</div>

#{modal nome:'editarLista', titulo:'Editar Lista'}
	<div id="divEditarLista" style="width: 800px !important; max-width: 800px !important;">#{include
				'Application/editarLista.html' /}</div>
#{/modal}

<script type="text/javascript">
	var solicitacaoTable,
		listaJson;

	var QueryString = function () {
		// This function is anonymous, is executed immediately and
		// the return value is assigned to QueryString!
		var query_string = {};
		var query = window.location.search.substring(1);
		var vars = query.split("&");
		for (var i=0;i<vars.length;i++) {
			var pair = vars[i].split("=");
	    	// If first entry with this name
	    	if (typeof query_string[pair[0]] === "undefined") {
				query_string[pair[0]] = pair[1];
				// If second entry with this name
			} else if (typeof query_string[pair[0]] === "string") {
				var arr = [ query_string[pair[0]], pair[1] ];
				query_string[pair[0]] = arr;
				// If third or later entry with this name
			} else {
				query_string[pair[0]].push(pair[1]);
			}
		}
		return query_string;
	}();
	
	$(function(){
	    $('#btn').click(function() {
	        if (!block())
	            return false;
	        var ids=[];
	    	$("#sortable > tr").each(function() {
				var id = $(this).attr('id');
	
				if (id != undefined && id != '')
	        		ids.push(id);
	 	    });
	
	 	    if (ids.length > 0)
	    		window.location.href = "@{Application.priorizarLista}?id=${lista.idLista}&ids="+ids;
	    });
	});

	var opts = {
			 urlGravar : '@{Application.gravarLista()}?',
			 dialogCadastro : $('#editarLista_dialog'),
			 objectName : 'lista',
			 formCadastro : $('#formLista')
		};	

	// Define a "classe" listaService
	function ListaService(opts) {
		// super(opts)
		BaseService.call(this, opts);
	}
	// listaService extends BaseService
	ListaService.prototype = Object.create(BaseService.prototype);

	var listaService = new ListaService(opts);
	// Sobescreve o metodo cadastrar para limpara tela
	listaService.cadastrar = function(title) {
		BaseService.prototype.cadastrar.call(this, title);
	}

	listaService.getId = function(lista) {
		return lista.idLista;
	}

	/**
	 * Customiza o metodo editar
	 */
	listaService.editar = function(obj, title) {
		BaseService.prototype.editar.call(this, obj, title); // super.editar();

		limparDadosListaModal();

		// carrega as permissões da lista
		carregarPermissoes(obj.idLista);
	}

	/**
	* Customiza o método onGravar()
	*/
	listaService.onGravar = function(obj, objSalvo) {
		listaJson = objSalvo;

		if (listaJson)
			$("#tituloPagina").html(listaJson.nomeLista);
	}

	function editarLista(event, jSon) {
		event.stopPropagation();

		if (!listaJson)
			listaJson = jSon;

		listaService.editar(listaJson, 'Alterar Lista');
	}
	
	function limparDadosListaModal() {
		// limpa as permissões
		permissoesTable.api().clear().draw();
	}

	function carregarPermissoes(id) {
        $.ajax({
        	type: "GET",
        	url: "@{Application.buscarPermissoesLista()}?idLista=" + id,
        	dataType: "text",
        	success: function(lista) {
        		var permissoesJSon = JSON.parse(lista);
        		populatePermissoesFromJSonList(permissoesJSon);
        	},
        	error: function(error) {
            	alert("Não foi possível carregar as Permissões desta Lista.");
        	}
       	});
    }

	function populatePermissoesFromJSonList(permissoesJSon) {
		for (var i = 0; i < permissoesJSon.length; i++) {
			var permissao = permissoesJSon[i],
				row = [ permissao.orgaoUsuario ? permissao.orgaoUsuario.id : '',
						permissao.orgaoUsuario ? permissao.orgaoUsuario.sigla : '', 
						permissao.complexo ? permissao.complexo.id : '',
						permissao.complexo ? permissao.complexo.descricao : '', 
						permissao.lotacao ? permissao.lotacao.id : '',
						permissao.lotacao ? permissao.lotacao.descricao : '', 
						permissao.lotacao ? permissao.lotacao.sigla : '', 
						permissao.pessoa ? permissao.pessoa.id : '',
						permissao.pessoa ? permissao.pessoa.descricao : '', 
						permissao.pessoa ? permissao.pessoa.sigla : '', 
						permissao.cargo ? permissao.cargo.id : '',
						permissao.cargo ? permissao.cargo.descricao : '', 
						permissao.cargo ? permissao.cargo.sigla : '',
						permissao.funcaoConfianca ? permissao.funcaoConfianca.id : '',
						permissao.funcaoConfianca ? permissao.funcaoConfianca.descricao : '', 
						permissao.funcaoConfianca ? permissao.funcaoConfianca.sigla : '',  
	          			permissao.listaTipoPermissaoListaVO,									//16
	          			permissao.idConfiguracao,												//17    
	          			'',																		//18
	          			getDescricaoTipoPermissaoByLista(permissao.listaTipoPermissaoListaVO),	//19
	          			getAcaoPermissao(permissao)
	          			];

			var tr = permissoesTable.api().row.add(row).draw().node();
			if(!permissao.ativo) {
				$(tr).find('td').addClass('item-desativado');
	  		}
		}

		function getAcaoPermissao(permissao) {
			if(permissao.ativo) {
	  			return '<a class="once desassociarPermissao" onclick="desativarPermissaoUsoListaEdicao(event, '+permissao.idConfiguracao+')" title="Remover permissão">' + 
							'<input class="idPermissao" type="hidden" value="'+permissao.idConfiguracao+'}"/>' + 
							'<img id="imgCancelar" src="/siga/css/famfamfam/icons/delete.png" style="margin-right: 5px;">' + 
						'</a>';
			}
			return new String();
		}
	}
</script>