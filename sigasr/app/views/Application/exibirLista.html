<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<script src="//cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>
<script src="/sigasr/public/javascripts/jquery.serializejson.min.js"></script>
<script src="/sigasr/public/javascripts/jquery.populate.js"></script>
<script src="/sigasr/public/javascripts/base-service.js"></script>

<style>
	#sortable table { height: 1.5em; line-height: 1.2em; }
	.ui-state-highlight { height: 1.5em; line-height: 1.2em; }
	
	/** CSS do numero **/
	.numero-solicitacao a {
		color: black;
	}
	.PRIORIDADE-IMEDIATO .numero-solicitacao a {
		color: red !important;
		font-weight: bold;
	}
	.PRIORIDADE-ALTO .numero-solicitacao a {
		color: #E0E000 !important;
		font-weight: bold;
	}
	.PRIORIDADE-MEDIO .numero-solicitacao a {
		color: blue !important;
		font-weight: bold;
	}
	.PRIORIDADE-BAIXO .numero-solicitacao a {
		color: green !important;
		font-weight: bold;
	}
	.PRIORIDADE-PLANEJADO .numero-solicitacao a {
		color: gray !important;
		font-weight: bold;
	}
	
	.legenda-prioridade {
		margin-top: 10px;
	}
	
	/** CSS da leganda **/
	.legenda-prioridade span{
		display: inline-block;
	}
	.legenda-prioridade .cor {
		height: 15px;
		width: 15px;
		display: inline-block;
		-webkit-border-radius: 3px;
		-moz-border-radius: 3px;
		border-radius: 3px;
	}
	
	.legenda-prioridade div {
		display: inline-block;
	}
	.legenda-prioridade .descricao {
		display: block;
	    margin-left: 20px;
	    margin-right: 15px;
	    margin-top: -18px;
	}
	.legenda-prioridade .PRIORIDADE-IMEDIATO .cor {
		background-color: red;
	}
	.legenda-prioridade .PRIORIDADE-ALTO .cor {
		background-color: #E0E000;
	}
	.legenda-prioridade .PRIORIDADE-MEDIO .cor {
		background-color: blue;
	}
	.legenda-prioridade .PRIORIDADE-BAIXO .cor {
		background-color: green;
	}
	.legenda-prioridade .PRIORIDADE-PLANEJADO .cor {
		background-color: gray;
	}
</style>

#{set podeRemover:lista.podeRemover(lotaTitular, cadastrante) /}
#{set podeEditar:lista.podeEditar(lotaTitular, cadastrante) /}
#{set podePriorizar:lista.podePriorizar(lotaTitular, cadastrante) /}

#{if podePriorizar}
	<script>
		QueryString = {};
	
		$(function() {
			$( "#sortable" ).sortable({placeholder: "ui-state-highlight"});
			$( "#sortable" ).disableSelection();
			$( "#sortable" ).sortable({update: function( event, ui ) {recalcularPosicao()}});
		});
	</script>
#{/if} 

<div class="gt-bd clearfix">
	<div class="gt-content clearfix">
	<h2 id="tituloPagina"> ${lista.nomeLista}</h2>
	
		<p class="gt-table-action-list">
			#{if podeEditar} 
				<a href="#" onclick="javascript: editarLista(event, ${lista.toJson()})"> 
					<img src="/siga/css/famfamfam/icons/pencil.png" style="margin-right: 5px;">Editar
				</a>&nbsp;&nbsp;&nbsp; 
			#{/if}
		</p>
 	
 	<div class="gt-content-box gt-for-table dataTables_div">
		<table id="solicitacao_table" class="display gt-table-nowrap">
			<col width="5%" />
			<col width="15%" />
    		<col width="24%" />
    		<col width="10%" />
    		<col width="10%" />
    		<col width="10%" />
    		<col width="20%" />
    		<col width="6%" />
    		<thead>
				<tr class="gt-celula-nowrap">
					<th style="color: #333; font-weight: bold; padding: 7px 10px;">#</th>
					<th style="color: #333; font-weight: bold; padding: 7px 10px;">Código</th>
					<th style="color: #333; font-weight: bold; padding: 7px 10px;">Teor</th>
					<th style="color: #333; font-weight: bold; padding: 7px 10px;">Solicitante</th>
					<th style="color: #333; font-weight: bold; padding: 7px 10px;">Aberto</th>
					<th style="color: #333; font-weight: bold; padding: 7px 10px;">Lotação</th>
					<th style="color: #333; font-weight: bold; padding: 7px 10px;">Última Movimentação</th>
					#{if podeRemover || podePriorizar}
						<th style="color: #333; font-weight: bold; padding: 7px 10px;"></th>
					#{/if}
				</tr>
			</thead>
			<tbody id="sortable" >
				#{list items:lista.getPrioridadeSolicitacaoSet(), as:'sol'}
					#{if sol}
					<tr  data-json-id="${sol.idPrioridadeSolicitacao}" data-json="${sol.toJson()}" id="${sol.solicitacao.idSolicitacao}"  class="PRIORIDADE-${sol.prioridade}">
						<td class="gt-celula-nowrap numero-solicitacao" style="cursor:move; font-size: 9pt; padding: 7px 10px; border-bottom: 1px solid #ccc !important;" "id="prioridade">
							<a>${sol.numPosicao}</a>
						</td>
						<td class="gt-celula-nowrap" style="font-size: 13px; font-weight: bold; border-bottom: 1px solid #ccc !important; padding: 7px 10px;">
							<a href="@{Application.exibir(sol.solicitacao.idSolicitacao)}">
								${sol.solicitacao.codigo}
							</a>	
						</td>
						<td class="gt-celula-nowrap"  style="font-size: 9pt; padding: 7px 10px; border-bottom: 1px solid #ccc !important; text-align:justify;" "id="descrSolicitacao">
						<b>#{descricaoItem itemConfiguracao: sol.solicitacao.itemAtual /}:</b>&nbsp;
						#{selecionado sigla:sol.solicitacao.descricao,descricao:sol.solicitacao.descricao /}
						</td>
							
						<td class="gt-celula-nowrap" style="font-size: 9pt; border-bottom: 1px solid #ccc !important; padding: 7px 10px; text-align:center;" >
						#{selecionado sigla:sol.solicitacao.solicitante.nomeAbreviado, descricao:sol.solicitacao.solicitante.descricaoIniciaisMaiusculas /}&nbsp;
						#{selecionado sigla:sol.solicitacao.lotaSolicitante.siglaLotacao,descricao:sol.solicitacao.lotaSolicitante.siglaLotacao /}
						</td>
						<td class="gt-celula-nowrap" style="font-size: 9pt; border-bottom: 1px solid #ccc !important; padding: 7px 10px;">
						#{selecionado sigla:sol.solicitacao.solicitacaoInicial.dtRegString,descricao:sol.solicitacao.solicitacaoInicial.dtRegString /}
						</td>						
						<td class="gt-celula-nowrap" style="font-size: 9pt; border-bottom: 1px solid #ccc !important; padding: 7px 10px;">
							<b>${sol?.solicitacao.lotaAtendente.siglaLotacao}</b></td>
						<td class="gt-celula-nowrap" style="font-size: 9pt; border-bottom: 1px solid #ccc !important; padding: 7px 10px;">
							#{selecionado sigla:sol.solicitacao.ultimaMovimentacaoQuePossuaDescricao?.descrMovimentacao,descricao:sol.solicitacao.ultimaMovimentacaoQuePossuaDescricao?.descrMovimentacao /}
						</td>
						
						<td class="gt-celula-nowrap" style="font-size: 13px; font-weight: bold; border-bottom: 1px solid #ccc !important; padding: 7px 10px;">
							#{if podeRemover} 
								<input type="hidden" name="idLista" value="${lista.idLista}">
								<input type="hidden" name="idSolicitacao" value="${sol.solicitacao.idSolicitacao}">
								<a onclick="javascript: return block();" href="@{Application.retirarDeLista(sol.solicitacao.idSolicitacao,lista.idLista)}" title="Remover da Lista" name="idSolicitacao" value="${sol.solicitacao.idSolicitacao}">
								<img id="imgCancelar" src="/siga/css/famfamfam/icons/delete.png" style="margin-right: 5px;"></img></a>
							#{/if}
							#{if podePriorizar}
								<a class="once gt-btn-ativar" onclick="listaService.alterarPosicao(event, ${sol.toJson()})" title="Alterar posição"> 
								<img src="/siga/css/famfamfam/icons/arrow_refresh_small_up_down.png" style="margin-right: 5px;"></img> </a>
								<a class="once gt-btn-ativar" onclick="listaService.alterarPrioridade(this)" title="Alterar prioridade"> 
								<img src="/siga/css/famfamfam/icons/arrow_switch.png" style="margin-right: 5px;"></img></a>
							#{/if}
						</td>
						
					</tr>		
					#{/if}		
				#{/list}
			</tbody>
		</table>
	</div>	
</div>


<div class="legenda-prioridade">
	<div class="PRIORIDADE-IMEDIATO">
		<span class="cor"></span>
		<span class="descricao">Imediata</span>
	</div>
	
	<div class="PRIORIDADE-ALTO">
		<span class="cor"></span>
		<span class="descricao">Alta</span>
	</div>
	
	<div class=PRIORIDADE-MEDIO>
		<span class="cor"></span>
		<span class="descricao">Média</span>
	</div>
	
	<div class="PRIORIDADE-BAIXO">
		<span class="cor"></span>
		<span class="descricao">Baixa</span>
	</div>
	
	<div class="PRIORIDADE-PLANEJADO">
		<span class="cor"></span>
		<span class="descricao">Planejada</span>
	</div>
</div>

<!-- /content box -->
<div class="gt-table-buttons">
	<input type="hidden" name="idLista" value="${lista.idLista}">
	#{if podePriorizar} 
	<input type="button" id="btn" value="Gravar" class="gt-btn-medium gt-btn-left" />#{/if}
	<a href="@{Application.listarLista}" class="gt-btn-medium gt-btn-left">Cancelar</a>
</div>

#{modal nome:'editarLista', titulo:'Editar Lista'}
	<div id="divEditarLista">#{include
				'Application/editarLista.html' /}</div>
#{/modal}

<!-- modal de posicao -->
#{modal nome:'posicao', titulo:'Posição da Solicitação na Lista'}
	<div class="gt-form gt-content-box">
		<form id="posicaoForm">
			<input id="idPrioridadePosicao" type="hidden" name="idPrioridadeSolicitacao" />
			
			<div id="numPosicao" class="gt-form-row gt-width-66">
				<label>Mover Para</label> 
				<input type="number" name="numPosicao"/>
			</div>
			
			<div class="gt-form-row">
				<input type="button" value="Ok" class="gt-btn-medium gt-btn-left" 
					onclick="reposicionar()" />
			</div>
		</form>
	</div>
#{/modal}

<!-- modal de prioridade -->
#{modal nome:'prioridade', titulo:'Alterar Prioridade'}
	<div class="gt-form gt-content-box">
		<form id="prioridadeForm">
			<input id="idPrioridadePrior" type="hidden" name="idPrioridadeSolicitacao" />
			
			<div id="prioridade" class="gt-form-row gt-width-66">
				<label>Prioridade</label> 
				<td>#{select 'prioridade', items:models.SrPrioridade.values(), 
						labelProperty:'descPrioridade', value:prioridade, style:'width:250px;' } 
						#{option 0}#{/option} #{/select}
				</td>					
			</div>
			<div id="naoReposicionarAutomatico" class="gt-width-250">
				<label>#{checkbox name:'naoReposicionarAutomatico',
					value:naoReposicionarAutomatico/} Não reposicionar automaticamente</label>
			</div>				
			
			<div class="gt-form-row">
				<input type="button" value="Ok" class="gt-btn-medium gt-btn-left" 
					onclick="gravarPrioridade()" />
			</div>
		</form>
	</div>
#{/modal}


<script type="text/javascript">
	var solicitacaoTable,
		listaJson;
	
	/* Table initialization */
	$(document).ready(function() {
		if ( $.fn.dataTable.isDataTable( '#solicitacao_table' ) ) {
			solicitacaoTable = $('#solicitacao_table').dataTable();
		}
		else {
			solicitacaoTable = $('#solicitacao_table').dataTable({
				"language": {
					"emptyTable":     "Não existem resultados",
				    "info":           "Mostrando de _START_ a _END_ do total de _TOTAL_ registros",
				    "infoEmpty":      "Mostrando de 0 a 0 do total de 0 registros",
				    "infoFiltered":   "(filtrando do total de _MAX_ registros)",
				    "infoPostFix":    "",
				    "thousands":      ".",
				    "lengthMenu":     "Mostrar _MENU_ registros",
				    "loadingRecords": "Carregando...",
				    "processing":     "Processando...",
				    "search":         "Filtrar:",
				    "zeroRecords":    "Nenhum registro encontrado",
				    "paginate": {
				        "first":      "Primeiro",
				        "last":       "Último",
				        "next":       "Próximo",
				        "previous":   "Anterior"
				    },
				    "aria": {
				        "sortAscending":  ": clique para ordenação crescente",
				        "sortDescending": ": clique para ordenação decrescente"
				    }
				},
				"bSort" : false,
				"bFilter": false,
				"bPaginate": false
			});
		}
	});

	$(function(){
	    $('#btn').click(function() {
	        if (!block())
	            return false;
	        var prioridades=[];
	    	$("#sortable > tr").each(function() {
	    		var prioridadeString = $(this).attr('data-json'),
	    			prioridade = JSON.parse(prioridadeString);
    			prioridades.push(prioridade);
	 	    });
	
	 	    if (prioridades.length > 0) {
	 	    	$.post('/sigasr/solicitacao/priorizarLista', {
		 	    	listaPrioridadeSolicitacao:prioridades,
		 	    	id:$('[name=idLista]').val(),
		 	    	success : function() {
		 	    		window.location.reload();
	 	    		}
	 	    	});
		 	}
	    });
	});

	var opts = {
			 urlGravar : '@{Application.gravarLista()}?',
			 dialogCadastro : $('#editarLista_dialog'),
			 objectName : 'lista',
			 formCadastro : $('#formLista')
		};	

	// Define a "classe" listaService
	function ListaService(opts) {
		// super(opts)
		BaseService.call(this, opts);
	}
	// listaService extends BaseService
	ListaService.prototype = Object.create(BaseService.prototype);

	var listaService = new ListaService(opts);
	// Sobescreve o metodo cadastrar para limpara tela
	listaService.cadastrar = function(title) {
		BaseService.prototype.cadastrar.call(this, title);
	}

	listaService.getId = function(lista) {
		return lista.idLista;
	}

	/**
	 * Customiza o metodo editar
	 */
	listaService.editar = function(obj, title) {
		BaseService.prototype.editar.call(this, obj, title); // super.editar();

		limparDadosListaModal();

		// carrega as permissões da lista
		carregarPermissoes(obj.idLista);
	}

	/**
	* Customiza o método onGravar()
	*/
	listaService.onGravar = function(obj, objSalvo) {
		listaJson = objSalvo;

		if (listaJson)
			$("#tituloPagina").html(listaJson.nomeLista);
	}

	listaService.alterarPosicao = function(event, obj) {
		$('#posicao_dialog').dialog('open');
		new Formulario($('#posicaoForm')).populateFromJson(obj);
	}

	listaService.alterarPrioridade = function(a) {
		var tr = $(a).parent().parent(),
			obj = JSON.parse(tr.attr('data-json'));
		
		$('#prioridade_dialog').dialog('open');
		new Formulario($('#prioridadeForm')).populateFromJson(obj);
	}
	
	function editarLista(event, jSon) {
		event.stopPropagation();

		if (!listaJson)
			listaJson = jSon;

		listaService.editar(listaJson, 'Alterar Lista');
	}
	
	function limparDadosListaModal() {
		// limpa as permissões
		permissoesTable.api().clear().draw();
	}

	function carregarPermissoes(id) {
        $.ajax({
        	type: "GET",
        	url: "@{Application.buscarPermissoesLista()}?idLista=" + id,
        	dataType: "text",
        	success: function(lista) {
        		var permissoesJSon = JSON.parse(lista);
        		populatePermissoesFromJSonList(permissoesJSon);
        	},
        	error: function(error) {
            	alert("Não foi possível carregar as Permissões desta Lista.");
        	}
       	});
    }

	function populatePermissoesFromJSonList(permissoesJSon) {
		for (var i = 0; i < permissoesJSon.length; i++) {
			var permissao = permissoesJSon[i],
				row = [ permissao.orgaoUsuario ? permissao.orgaoUsuario.id : '',
						permissao.orgaoUsuario ? permissao.orgaoUsuario.sigla : '', 
						permissao.complexo ? permissao.complexo.id : '',
						permissao.complexo ? permissao.complexo.descricao : '', 
						permissao.lotacao ? permissao.lotacao.id : '',
						permissao.lotacao ? permissao.lotacao.descricao : '', 
						permissao.lotacao ? permissao.lotacao.sigla : '', 
						permissao.pessoa ? permissao.pessoa.id : '',
						permissao.pessoa ? permissao.pessoa.descricao : '', 
						permissao.pessoa ? permissao.pessoa.sigla : '', 
						permissao.cargo ? permissao.cargo.id : '',
						permissao.cargo ? permissao.cargo.descricao : '', 
						permissao.cargo ? permissao.cargo.sigla : '',
						permissao.funcaoConfianca ? permissao.funcaoConfianca.id : '',
						permissao.funcaoConfianca ? permissao.funcaoConfianca.descricao : '', 
						permissao.funcaoConfianca ? permissao.funcaoConfianca.sigla : '',  
	          			permissao.listaTipoPermissaoListaVO,									//16
	          			permissao.idConfiguracao,												//17    
	          			'',																		//18
	          			getDescricaoTipoPermissaoByLista(permissao.listaTipoPermissaoListaVO),	//19
	          			'<a class="once desassociarPermissao" onclick="desativarPermissaoUsoListaEdicao(event, '+permissao.idConfiguracao+')" title="Remover permissão">' + 
						'<input class="idPermissao" type="hidden" value="'+permissao.idConfiguracao+'}"/>' + 
						'<img id="imgCancelar" src="/siga/css/famfamfam/icons/delete.png" style="margin-right: 5px;">' + 
						'</a>'																	//20
	          			];

			permissoesTable.api().row.add(row).draw();
		}
	}

	function reposicionar() {
		var novaPosicao = $('[name=numPosicao]').val(),
			lista = $("#sortable > tr"),
			idPrioridadeSolicitacao = $('#idPrioridadePosicao').val(),
			tr = $('[data-json-id= '+ idPrioridadeSolicitacao + ']'),
			size = lista.size(),
			stringPrioridadeSolicitacao = $(tr).attr('data-json'),
			prioridadeSolicitacao = JSON.parse(stringPrioridadeSolicitacao);

		if (novaPosicao <= 0) {
			tr.insertBefore($(lista[0]));
		} 
		else if (novaPosicao >= size) {
			tr.insertAfter($(lista[size-1]));
		}
		else {
			if (prioridadeSolicitacao.numPosicao < novaPosicao) {
				tr.insertBefore($(lista[novaPosicao]));
			}
			else tr.insertBefore($(lista[novaPosicao-1]));
		}
		recalcularPosicao();
		$('#posicao_dialog').dialog('close');
	}

	function recalcularPosicao() {
		var posicao = 0;
		$("#sortable > tr").each(function() {
			var me = $(this),
				objString = me.attr('data-json'),
				obj = JSON.parse(objString),
				numPosicaoAntiga = obj.numPosicao;

			posicao++;
			
			obj.numPosicao = posicao;
			me.attr('data-json', JSON.stringify(obj));
			me.find('td:first').find('a').html(posicao);
		});		
		
	}
	
	function gravarPrioridade() {
		var novaPrioridade = $('[name=prioridade]').val(),
			idPrioridadeSolicitacao = $('#idPrioridadePrior').val(),
			tr = $('[data-json-id= '+ idPrioridadeSolicitacao + ']'),
			jsonString = $(tr).attr('data-json'),
			objString = jsonString,
			obj = JSON.parse(objString);

		tr.removeClass('PRIORIDADE-' + obj.prioridade);
		tr.addClass('PRIORIDADE-' + novaPrioridade);
		obj.prioridade = novaPrioridade;
		tr.attr('data-json', JSON.stringify(obj));

		if (!obj.naoReposicionarAutomatico) {
			reposicionarPorPrioridade(obj, tr);
		}
		recalcularPosicao();
		$('#prioridade_dialog').dialog('close');
	}

	function reposicionarPorPrioridade(obj, tr) {
		var posicao = 0,
			lista = $("#sortable > tr");

		$("#sortable > tr").each(function() {
			var me = $(this),
				objStringLista = me.attr('data-json'),
				objLista = JSON.parse(objStringLista);
			
			if (obj.prioridade == objLista.prioridade) {
				tr.insertAfter($(lista[posicao]));
			}
			posicao++;
		});
	}
</script>